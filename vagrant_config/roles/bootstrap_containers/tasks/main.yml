---
- name: start database container
  docker:
    name: develdbmaster
    image: percona:5.6
    state: reloaded
    ports:
      - "3306:3306"
    volumes:
      - /home/vagrant/mysqldata:/var/lib/mysql
    env:
      MYSQL_ROOT_PASSWORD: tpl9
      MYSQL_DATABASE: euromillions

- name: start compass web container
  docker:
    name: compassweb
    image: antonienko/compass-watch
    command: watch --poll /src/compass_web
    volumes: /var/www:/src

- name: start compass admin container
  docker:
    name: compasadmin
    image: antonienko/compass-watch
    command: watch --poll /src/compass_admin
    volumes: /var/www:/src

- name: start redis container
  docker:
    name: develredis
    image: redis
    ports:
      - "6379:6379"

- name: build web container
  docker_image:
    name: develweb
    path: /vagrant/src/docker/devel-web
    state: present

- name: start web container
  docker:
    name: develweb
    image: develweb
    state: reloaded
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/www:/var/www
      - /vagrant/src/docker/devel-web/nginxconfig:/etc/nginx/sites-enabled
      - /vagrant/src/docker/devel-web/certs:/etc/nginx/ssl
    links:
      - develdbmaster:mysql
      - develredis:redis
    env:
      EM_ENV: development

- name: initialize test database
  shell:  mysql -h 127.0.0.1 -u root -ptpl9 -e 'CREATE DATABASE IF NOT EXISTS euromillions_test'